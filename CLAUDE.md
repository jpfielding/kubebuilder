# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Kubebuilder learning lab - a minimal testbed for building, testing, and deploying Kubernetes operators. The repository is designed to host multiple operator projects under the `operators/` directory, each initialized with Kubebuilder.

**Module**: `github.com/jpfielding/kubeviewer`
**Go Version**: 1.25
**Primary Language**: Go
**Environment**: Dev Container with Rocky Linux 9, Docker-in-Docker support

## Development Environment

All development happens inside VS Code Dev Containers. The devcontainer provides:
- Go 1.25.6 toolchain
- Docker access via `/var/run/docker.sock` mounted from host
- Per-project isolated bash history and kubeconfig
- Git credentials, SSH keys, and Claude config mounted from host
- Custom `.bash_pretty` prompt configuration

### Critical Environment Details

1. **Kubernetes Config Isolation**: Each project uses its own kubeconfig at `~/.kube-${localWorkspaceFolderBasename}` on the host
2. **Docker Socket**: Accessible at `/var/run/docker.sock` inside container (requires `docker` group membership)
3. **Kind Cluster Setup**: Use `./kind-from-devcontainer.sh` script to create Kind clusters accessible via `host.docker.internal`

## Core Commands

### Testing
```bash
make test              # Run short tests only
make test-report       # Run ALL tests with JUnit XML output (tmp/report.xml)
make integration-test  # Run integration tests
```

### Code Quality
```bash
make lint              # Run golangci-lint on pkg/
make lint-report       # Generate Code Climate JSON report (tmp/gl-code-quality-report.json)
make vet               # Run go vet
make vulnerability     # Run govulncheck (requires install-govulncheck first)
make vulnerability-report  # Generate vulnerability JSON report
```

### Building
```bash
make build             # Build binary to bin/dicosctl with CGO_ENABLED=0
make clean             # Remove bin/ directory and test outputs
make nuke              # Complete reset via git clean -ffdqx (DESTRUCTIVE)
```

### Tool Installation
```bash
make install-tools     # Install all tools (Claude, cert tools, GitLab CLI, CI/CD tools)
make install-cicd-tools  # Install gotestsum, govulncheck, golangci-lint
make install-kubectl   # Install kubectl v1.35
```

## Kubebuilder Operator Workflow

When creating or working with operators under `operators/`:

1. **Initialize new operator**:
   ```bash
   mkdir -p operators/<name>
   cd operators/<name>
   kubebuilder init --domain example.com --repo github.com/myorg/<name>
   ```

2. **Create API/Controller**:
   ```bash
   kubebuilder create api --group apps --version v1 --kind MyResource
   ```

3. **Development cycle**:
   ```bash
   make manifests generate  # Generate CRDs and deepcopy code
   make test                # Run tests
   make run                 # Run controller locally (outside cluster)
   ```

4. **Deploy to cluster**:
   ```bash
   make install             # Install CRDs
   make deploy IMG=<registry>/<name>:tag
   ```

5. **Cleanup**:
   ```bash
   make undeploy            # Remove operator from cluster
   make uninstall           # Remove CRDs
   ```

## Architecture Notes

### Project Structure
- `operators/` - Multiple operator projects (each is a separate Kubebuilder project)
  - `api/` - CRD type definitions
  - `controllers/` - Reconciliation logic
  - `config/` - Kubernetes manifests (CRDs, RBAC, manager deployment)
  - `config/samples/` - Example custom resource instances
- `cmd/` - Minimal main package (currently a stub)
- `.claude/skills/` - Claude Code skills including k8s-operator-expert
- `.devcontainer/` - Complete dev container configuration

### Kubebuilder Patterns
- Each operator project is self-contained with its own Makefile (generated by Kubebuilder)
- CRD generation uses controller-gen with Kubebuilder markers (comments like `+kubebuilder:validation:Required`)
- Controllers follow the controller-runtime reconciliation pattern
- Testing uses envtest (test control plane without full cluster)

### Kind Cluster from Dev Container
The `kind-from-devcontainer.sh` script creates clusters with special configuration:
- Adds `host.docker.internal` as API server certSAN
- Reconfigures kubeconfig to use `host.docker.internal` instead of localhost
- This allows the dev container to access the Kind cluster running in Docker Desktop

## CI/CD Pipeline

GitLab CI runs three test stages and one publish stage:

1. **test** - Run Go tests with JUnit reporting
2. **code-security** - Run govulncheck (allowed to fail)
3. **code-quality** - Run golangci-lint (allowed to fail)
4. **build** - Compile binary artifact (bin/dicosctl)

All stages use `golang:1.25.6-alpine3.22` image.

## Important Conventions

- Test files live alongside source in `pkg/` (not a separate test directory)
- Short tests via `-short` flag; integration tests run without it
- Build outputs go to `bin/` directory
- Temporary CI artifacts written to `tmp/` directory
- Git SHA embedded in binary via `-ldflags "-X 'main.GitSHA=$(GIT_SHA)'"`
- CGO disabled for static binary compilation

## Claude Code Skills

This repository includes custom skills in `.claude/skills/`:
- **k8s-operator-expert** - Specialized guidance for Kubernetes operator development, reconciliation patterns, markers, and troubleshooting
- **commit-helper** - Generates clear commit messages from git diffs
- **explaining-code** - Explains code with visual diagrams
- **skill-creator** - Guide for creating new skills
